<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="file_0000000042b861fd808de615ad3ddea5.png" type="image/png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - KuGuider</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet"/>

  <style>
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:0;
      font-family:'Poppins',sans-serif;
      background:#f0f2f5;
      height:100vh;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    nav{
      background:#fff;
      padding:6px 10px;
      width: 100%;
      max-width: 500px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      z-index:10;
      margin: 0 auto 0;
    }
    nav h3{
      margin:0;
      font-size:17px;
    }
    nav .sub{
      font-size:11px;
      color:#555;
      margin-top:2px;
    }
    #closeChatBtn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:6px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #closeChatBtn i{
      font-size:20px;
    }

    #chatContainer{
      flex:1;
      margin-bottom:80px;
      width:100%;
      max-width:500px;
      padding:0.8rem;
      align-self:center;
      overflow-y:auto;
      background:#f0f2f5;
      position:relative;
    }
    #chatMessages{
      list-style:none;
      padding:0;
      margin:1rem 0;
      display:flex;
      flex-direction:column;
    }
    #chatMessages li{
      display:flex;
      margin:0.4rem 0;
      max-width:80%;
      position:relative;
      transition:0.15s;
      animation:fadeInUp 0.18s ease;
    }
    #chatMessages li.own{
      align-self:flex-end;
      flex-direction:row-reverse;
    }
    .bubble{
      padding:0.6rem 1rem;
      border-radius:18px;
      font-size:0.95rem;
      max-width:100%;
      word-wrap:break-word;
      position:relative;
    }
    .own .bubble{
      background:#212121;
      color:#fff;
    }
    .other .bubble{
      background:#e5e5ea;
    }
    .avatar{
      width:32px;height:32px;
      border-radius:50%;
      margin:0 5px;
    }

    .inlineMenu{
      position:absolute;
      top:-40px;
      right:0;
      background:#fff;
      border:1px solid #ccc;
      border-radius:8px;
      display:flex;
      z-index:999;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      animation:popIn 0.12s ease;
    }
    .inlineMenu button{
      border:none;
      background:none;
      padding:6px 10px;
      cursor:pointer;
      font-size:0.8rem;
    }
    .inlineMenu button i{
      font-size:0.8rem;
    }

    /* Reply preview with cancel X */
    #replyPreview{
      display:none;
      width: 100%;
      max-width:500px;
      margin:4px 4px 0px 9px;
      background:#212121;
      color:white;
      padding:7px 10px;
      border-left:4px solid #ffffff;
      border-radius:8px;
      font-size:0.85rem;
      align-self:center;
      animation:slideIn 0.18s ease;
      position:relative;
    }
    #replyPreviewContent{
      font-size:0.82rem;
      padding-right:26px;
    }
    #replyPreviewClose{
      position:absolute;
      top:5px;
      right:5px;
      border:none;
      background:#333;
      color:#fff;
      width:22px;
      height:22px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:0.8rem;
    }

    #chatInputContainer{
      position:fixed;
      bottom:5px;
      left:10px;
      right:10px;
      display:flex;
      align-items:center;
      background:none;
      padding:5px 10px;
      border-radius:40px;
      max-width:500px;
      margin:auto;
      box-shadow:0 -1px 4px rgba(0,0,0,0.08);
    }
    #chatInput{
      flex:1;
      border:none;
      outline:none;
      padding:10px 10px;
      font-size:1rem;
      background:#f0f0f0;
      border-radius:20px;
    }
    #sendBtn{
      width:45px;
      height:45px;
      border-radius:50%;
      border:none;
      background:#212121;
      color:white;
      display:flex;
      justify-content:center;
      align-items:center;
      font-size:1.2rem;
      margin-left:6px;
      cursor:pointer;
    }

    #loadingOverlay{
      position:absolute;
      left:0;top:0;right:0;bottom:0;
      background:rgba(255,255,255,0.8);
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:999;
    }
    .loader{
      width:40px;height:40px;
      border:4px solid #ddd;
      border-top:4px solid #212121;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }

    .meta-row{
      margin-top:4px;
      font-size:0.7rem;
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      opacity:0.85;
    }
    .meta-row .time{
      opacity:0.8;
    }
    .meta-row .status{
      font-size:0.7rem;
    }
    .status-sending{color:#999;}
    .status-sent{color:#bbb;}
    .status-seen{color:#4fc3f7;font-weight:600;}
    .meta-row .like{
      display:flex;
      align-items:center;
      gap:2px;
      font-size:0.7rem;
    }
    .meta-row .like i{
      font-size:0.7rem;
    }

    #typingIndicator{
      display:none;
    }

    @keyframes spin{to{transform:rotate(360deg);}}
    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(8px);}
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(6px);}
      to{opacity:1;transform:translateY(0);}
    }
    @keyframes popIn{
      from{opacity:0;transform:scale(0.85);}
      to{opacity:1;transform:scale(1);}
    }
  </style>
</head>

<body>

<nav>
  <div style="margin-left:5px;">
    <h3>Group Chat</h3>
    <div class="sub">
      <span id="onlineCount">0 online</span>
      ·
      <span id="typingIndicator">Someone is typing...</span>
    </div>
  </div>

  <!-- header close -->
  <button id="closeChatBtn" aria-label="Close chat">
    <i class="fa fa-times"></i>
  </button>
</nav>

<!-- reply preview -->
<div id="replyPreview">
  <div id="replyPreviewContent"></div>
  <button id="replyPreviewClose" aria-label="Cancel reply">
    <i class="fa fa-times"></i>
  </button>
</div>

<div id="chatContainer">
  <div id="loadingOverlay"><div class="loader"></div></div>
  <ul id="chatMessages"></ul>
</div>

<div id="chatInputContainer">
  <input id="chatInput" placeholder="Type a message...">
  <button id="sendBtn"><i class="fa fa-paper-plane"></i></button>
</div>

<audio id="msgSound" src="/notification.wav"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.9.1/firebase-auth-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyBmbFYqpuqaWCxmh7VqKTb_8CUvyEohzbw",
  authDomain:"kuguider.firebaseapp.com",
  projectId:"kuguider"
};
firebase.initializeApp(firebaseConfig);

const db=firebase.firestore();
const auth=firebase.auth();

let currentUserId = "";
let currentUserName = "";
let currentUserPhoto = "https://www.w3schools.com/howto/img_avatar.png";

let editDocId = null;
let replyTo = null;

let usersRef = null;
let typingDocRef = null;
let typingTimeout = null;

const chatMessages = document.getElementById("chatMessages");
const chatInput = document.getElementById("chatInput");
const replyPreview = document.getElementById("replyPreview");
const replyPreviewContent = document.getElementById("replyPreviewContent");
const replyPreviewClose = document.getElementById("replyPreviewClose");
const loadingOverlay = document.getElementById("loadingOverlay");
const msgSound = document.getElementById("msgSound");
const onlineCountEl = document.getElementById("onlineCount");
const typingIndicatorEl = document.getElementById("typingIndicator");


// ---------------- HELPERS: TIME, STATUS, LIKE ----------------
function getTimeHTML(data){
  if(!data.createdAt) return "";
  try{
    const date = data.createdAt.toDate();
    const timeStr = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return `<span class="time">${timeStr}</span>`;
  }catch(e){
    return "";
  }
}

function getStatusHTML(data){
  if(data.name !== currentUserName) return "";
  let text="Sending…", cls="status-sending";
  if(data.createdAt){
    text="Sent ✓";
    cls="status-sent";
  }
  if(data.seenBy && data.seenBy.length>0){
    text="Seen ✓✓";
    cls="status-seen";
  }
  return `<span class="status ${cls}">${text}</span>`;
}

function getLikeHTML(data){
  const likedBy = data.likedBy || [];
  if(likedBy.length===0) return "";
  return `<span class="like"><i class="fa fa-heart"></i> ${likedBy.length}</span>`;
}


// ---------------- SWIPE + LONG PRESS + DOUBLE TAP (scroll-safe) ----------------
function enableSwipeAndGestures(li, data, docId){
  let startX=0, startY=0, diffX=0, diffY=0;
  let pressTimer=null;
  let swiping=false;
  let scrolling=false;

  li.lastTapTime = li.lastTapTime || 0;

  li.addEventListener("touchstart", e=>{
    if(e.touches.length!==1) return;
    const t=e.touches[0];
    startX=t.clientX;
    startY=t.clientY;
    diffX=diffY=0;
    swiping=false;
    scrolling=false;

    // long-press reply
    pressTimer = setTimeout(()=>{
      if(!swiping && !scrolling){
        replyTo = data;
        showReplyPreview(data);
      }
    }, 500);
  });

  li.addEventListener("touchmove", e=>{
    if(e.touches.length!==1) return;
    const t=e.touches[0];
    diffX = t.clientX - startX;
    diffY = t.clientY - startY;

    // detect vertical scroll
    if(!swiping && !scrolling &&
       Math.abs(diffY) > 12 && Math.abs(diffY) > Math.abs(diffX)){
      scrolling = true;
      if(pressTimer){clearTimeout(pressTimer); pressTimer=null;}
      li.style.transform="translateX(0px)";
      return;
    }

    // activate swipe 
    if(!scrolling && !swiping &&
       Math.abs(diffX) > 35 && Math.abs(diffY) < 12){
      swiping = true;
      if(pressTimer){clearTimeout(pressTimer); pressTimer=null;}
    }

    if(swiping && diffX>0){
      li.style.transform=`translateX(${Math.min(diffX,55)}px)`;
    }
  });

  li.addEventListener("touchend", ()=>{
    if(pressTimer){
      clearTimeout(pressTimer);
      pressTimer=null;
    }

    if(swiping && diffX>40){
      replyTo = data;
      showReplyPreview(data);
    } else if(!scrolling && !swiping){
      // double tap like
      const now = Date.now();
      if(Math.abs(diffX)<8 && Math.abs(diffY)<8 && now - li.lastTapTime < 300){
        toggleLike(docId, data);
      }
      li.lastTapTime = now;
    }

    li.style.transition="0.2s";
    li.style.transform="translateX(0px)";
    setTimeout(()=>li.style.transition="",200);
  });

  // Desktop: double-click like
  li.addEventListener("dblclick", ()=>toggleLike(docId,data));
}


// ---------------- TOGGLE LIKE ----------------
function toggleLike(docId, data){
  if(!currentUserId) return;
  const likedBy = data.likedBy || [];
  const alreadyLiked = likedBy.includes(currentUserId);
  const ref = db.collection("chat").doc(docId);

  if(alreadyLiked){
    ref.update({
      likedBy: firebase.firestore.FieldValue.arrayRemove(currentUserId)
    });
  } else {
    ref.update({
      likedBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
    });
  }
}


// ---------------- REPLY PREVIEW ----------------
function showReplyPreview(data){
  replyPreview.style.display="block";
  replyPreviewContent.innerHTML = `<b>${data.name}</b><br>${data.message}`;
}
function clearReplyPreview(){
  replyPreview.style.display="none";
  replyPreviewContent.innerHTML="";
  replyTo = null;
}
replyPreviewClose.addEventListener("click", clearReplyPreview);


// ---------------- EDIT / DELETE MENU ----------------
function showMenu(li, docId, data){
  if(!li.classList.contains("own")) return;

  document.querySelectorAll(".inlineMenu").forEach(m=>m.remove());

  const menu = document.createElement("div");
  menu.className="inlineMenu";

  const closeBtn = document.createElement("button");
  closeBtn.innerHTML = "<i class='fa fa-times'></i>";
  closeBtn.onclick = () => menu.remove();

  const editBtn = document.createElement("button");
  editBtn.innerText="Edit";
  editBtn.onclick=()=>{
    chatInput.value = data.message;
    editDocId = docId;
    menu.remove();
  };

  const delBtn = document.createElement("button");
  delBtn.innerText="Delete";
  delBtn.onclick=()=>{
    db.collection("chat").doc(docId).delete();
    menu.remove();
  };

  menu.appendChild(closeBtn);
  menu.appendChild(editBtn);
  menu.appendChild(delBtn);
  li.appendChild(menu);
}


// ---------------- SEND MESSAGE ----------------
function sendMessage(){
  const msg=chatInput.value.trim();
  if(!msg) return;

  let obj = {
    name: currentUserName,
    photo: currentUserPhoto,
    message: msg,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    likedBy: [],
    seenBy: []
  };

  if(replyTo){
    obj.reply = {
      name: replyTo.name,
      message: replyTo.message
    };
  }

  if(editDocId){
    db.collection("chat").doc(editDocId).update({message:msg});
    editDocId=null;
  } else {
    db.collection("chat").add(obj);
  }

  chatInput.value="";
  clearReplyPreview();
  handleTypingState();
}


// ---------------- LOAD CHAT ----------------
function loadChat(){
  db.collection("chat").orderBy("createdAt").onSnapshot(snapshot=>{
    loadingOverlay.style.display="none";
    chatMessages.innerHTML="";

    snapshot.forEach(doc=>{
      const data = doc.data();

      const li=document.createElement("li");
      li.className = (data.name===currentUserName) ? "own" : "other";

      let replyHTML = "";
      if(data.reply){
        replyHTML =
        `<div style="background:rgba(0,0,0,0.3);padding:6px;border-left:3px solid lightgrey;border-radius:6px;margin-bottom:4px;font-size:0.8rem;">
          <b>${data.reply.name}</b><br>${data.reply.message}
        </div>`;
      }

      li.innerHTML = `
        <img class="avatar" src="${data.photo || currentUserPhoto}">
        <div class="bubble">
          <span class="name" style="font-weight:600;font-size:0.8rem;display:block;margin-bottom:2px;">${data.name}</span>
          ${replyHTML}
          <div>${data.message}</div>
          <div class="meta-row">
            ${getTimeHTML(data)}
            ${getStatusHTML(data)}
            ${getLikeHTML(data)}
          </div>
        </div>
      `;

      // open menu on own message tap
      li.addEventListener("click", ()=>{
        if(li.classList.contains("own")){
          showMenu(li, doc.id, data);
        }
      });

      enableSwipeAndGestures(li, data, doc.id);

      // mark as seen
      if(currentUserId && data.name !== currentUserName){
        const seenBy = data.seenBy || [];
        if(!seenBy.includes(currentUserId)){
          db.collection("chat").doc(doc.id).update({
            seenBy: firebase.firestore.FieldValue.arrayUnion(currentUserId)
          });
        }
      }

      chatMessages.appendChild(li);
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;

    if(snapshot.docChanges().some(c=>c.type==="added"))
      msgSound.play();
  });
}


// ---------------- PRESENCE (ONLINE USERS) ----------------
function setupPresence(){
  if(!currentUserId) return;
  usersRef = db.collection("users").doc(currentUserId);
  usersRef.set({
    name: currentUserName,
    photo: currentUserPhoto,
    online:true,
    lastActive: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});

  window.addEventListener("beforeunload", ()=>{
    if(usersRef){
      usersRef.set({
        online:false,
        lastActive: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }
  });

  db.collection("users").where("online","==",true).onSnapshot(snap=>{
    const count = snap.size;
    onlineCountEl.textContent = count + (count===1 ? " online":" online");
  });
}


// ---------------- TYPING INDICATOR ----------------
function setupTyping(){
  if(!currentUserId) return;
  typingDocRef = db.collection("typing").doc(currentUserId);

  db.collection("typing").where("isTyping","==",true).onSnapshot(snap=>{
    let someone = false;
    snap.forEach(d=>{
      if(d.id !== currentUserId) someone = true;
    });
    typingIndicatorEl.style.display = someone ? "inline" : "none";
  });
}

function handleTypingState(){
  if(!typingDocRef) return;
  const isTyping = chatInput.value.trim().length>0;

  typingDocRef.set({
    name: currentUserName,
    isTyping: isTyping,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});

  if(typingTimeout) clearTimeout(typingTimeout);
  if(isTyping){
    typingTimeout = setTimeout(()=>{
      typingDocRef.set({isTyping:false},{merge:true});
    }, 3000);
  }
}


// ---------------- AUTH CHECK ----------------
auth.onAuthStateChanged(user=>{
  if(!user) location.href="index.html";
  else{
    currentUserId = user.uid;
    currentUserName = user.displayName || "Anonymous";
    currentUserPhoto = user.photoURL || currentUserPhoto;

    setupPresence();
    setupTyping();
    loadChat();
  }
});


// ---------------- EVENTS ----------------
document.getElementById("sendBtn").onclick = sendMessage;

chatInput.addEventListener("keypress", e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    sendMessage();
  }
});

chatInput.addEventListener("input", handleTypingState);

document.getElementById("closeChatBtn").addEventListener("click", ()=>{
  history.back();
});
</script>

</body>
</html>